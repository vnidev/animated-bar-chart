(function(a){a.fn.animatedBarChart=function(d){var o=this;var s=a(o).attr("id");var k=a.extend(true,{},{data:[],params:{group_name:"group_name",name:"name",value:"value"},chart_height:400,colors:null,show_legend:true,x_grid_lines:true,y_grid_lines:true,tweenDuration:300,bars:{padding:0.075,opacity:0.7,opacity_hover:0.45,disable_hover:false,hover_name_text:"name",hover_value_text:"value",},number_format:{format:",.2f",decimal:".",thousands:",",grouping:[3],currency:["$"]},margin:{top:0,right:35,bottom:20,left:70},rotate_x_axis_labels:{process:true,minimun_resolution:720,bottom_margin:15,rotating_angle:90,x_position:9,y_position:-3}},d);if(!k.colors){k.colors=[];var b=d3.scaleOrdinal(d3.schemeCategory10);for(var v=0;v<10;v++){k.colors.push(b(v))}}var n=0;if(!k.bars.disable_hover){n=20}var c=[];a.each(k.data,function(i,z){c.push(z[k.params.group_name])});c=a.unique(c);var q=false;if(a(document).width()<k.rotate_x_axis_labels.minimun_resolution&&k.rotate_x_axis_labels.process){k.margin.bottom=k.margin.bottom+k.rotate_x_axis_labels.bottom_margin;q=true}d3.formatDefaultLocale(k.number_format);var t=d3.format(k.number_format.format);var g=a("#"+s);var e=g.width();var y=k.chart_height;var u=d3.select("#"+s).append("svg").attr("width","100%").attr("height",k.chart_height).attr("viewBox","0 0 "+e+" "+y).attr("preserveAspectRatio","none");var p=u.append("g").attr("class","svg_chart").attr("transform","translate("+k.margin.left+", "+k.margin.top+n+")");var h=d3.scaleBand().range([0,e-k.margin.left-k.margin.right]).domain(k.data.map(function(i){return i[k.params.name]})).padding(k.bars.padding);var m=d3.scaleLinear().range([y-k.margin.top-k.margin.bottom-n,0]).domain([0,d3.max(k.data,function(i){return i[k.params.value]})]);p.append("g").attr("class","xaxis").attr("transform","translate(0, "+(y-k.margin.top-k.margin.bottom-n)+")").call(d3.axisBottom(h));p.append("g").attr("class","yaxis").call(d3.axisLeft(m).ticks(5));var w=p.append("g").attr("class","chart_container");function f(){return d3.axisBottom(h)}function l(){return d3.axisLeft(m)}var j;if(k.x_grid_lines){j=p.append("g").attr("class","x_lines").attr("transform","translate(0,"+(y-k.margin.top-k.margin.bottom-n)+")")}var x;if(k.y_grid_lines){x=p.append("g").attr("class","y_lines")}var r;if(k.show_legend){r=d3.select("#"+s).append("div").attr("class","legend_div").append("ul")}o.render=function(){m.domain([0,d3.max(k.data,function(z){return z[k.params.value]})]);p.select(".yaxis").transition().duration(k.tweenDuration).call(d3.axisLeft(m));h.domain(k.data.map(function(z){return z[k.params.name]}));p.select(".xaxis").transition().duration(k.tweenDuration).call(d3.axisBottom(h));if(q){p.select(".xaxis").selectAll("text").transition().duration(k.tweenDuration).attr("y",k.rotate_x_axis_labels.y_position).attr("x",k.rotate_x_axis_labels.x_position).attr("transform","rotate("+k.rotate_x_axis_labels.rotating_angle+")").style("text-anchor","start")}if(k.x_grid_lines){j.transition().duration(k.tweenDuration).call(f().tickSize(-(y-k.margin.top-k.margin.bottom-n)).tickFormat(""))}if(k.y_grid_lines){x.transition().duration(k.tweenDuration).call(l().tickSize(-(e-k.margin.left-k.margin.right)).tickFormat(""))}if(k.show_legend){o.addChartLegend()}var i=w.selectAll("rect").data(k.data);i.enter().append("rect").attr("class","bar_item").style("fill",function(B,A){var z=o.getDistinctDataIndex(B[k.params.group_name]);return k.colors[z]}).style("opacity",k.bars.opacity).attr("x",function(B,A){var z=o.getDistinctDataIndex(B[k.params.group_name]);return h(B[k.params.name])+(z*h.bandwidth()/c.length)}).attr("y",function(z){return m(0)}).attr("width",function(z){return h.bandwidth()/c.length}).attr("height",0).on("mouseover",function(B,A){if(!k.bars.disable_hover){var z=B[k.params.group_name]+", "+k.bars.hover_name_text+": "+B[k.params.name]+", "+k.bars.hover_value_text+": "+t(B[k.params.value]);u.append("text").attr("class","title-text").style("fill",function(){var C=o.getDistinctDataIndex(B[k.params.group_name]);return k.colors[C]}).text(z).attr("text-anchor","middle").attr("x",(e)/2).attr("y",n-7);d3.select(this).style("opacity",k.bars.opacity_hover).style("cursor","pointer")}}).on("mouseout",function(z){if(!k.bars.disable_hover){u.select(".title-text").remove();d3.select(this).style("opacity",k.bars.opacity)}}).transition().duration(k.tweenDuration).attr("y",function(z){return m(z[k.params.value])}).attr("height",function(z){return y-k.margin.top-k.margin.bottom-n-m(z[k.params.value])});i.data(k.data).transition().duration(k.tweenDuration).style("fill",function(B,A){var z=o.getDistinctDataIndex(B[k.params.group_name]);return k.colors[z]}).attr("x",function(B,A){var z=o.getDistinctDataIndex(B[k.params.group_name]);return h(B[k.params.name])+(z*h.bandwidth()/c.length)}).attr("width",h.bandwidth()/c.length).attr("y",function(z){return m(z[k.params.value])}).attr("height",function(z){return y-k.margin.top-k.margin.bottom-n-m(z[k.params.value])});i.exit().transition().duration(k.tweenDuration).style("opacity",0).remove()};o.addChartLegend=function(){var A=r.selectAll("li").data(c);var i=A.enter().append("li");i.append("div").attr("style",function(C,B){return"background-color: "+k.colors[B]});i.append("p").text(function(B){return B});var z=A.data(c);z.select("div").attr("style",function(C,B){return"background-color: "+k.colors[B]});z.select("p").text(function(B){return B});A.exit().remove()};o.updateChart=function(i){k=a.extend(k,i);c=[];a.each(k.data,function(z,A){c.push(A[k.params.group_name])});c=a.unique(c);o.render()};o.getDistinctDataIndex=function(z){var i=0;a.each(c,function(A,B){if(z==B){i=A;return false}});return i};o.render();return o}}(jQuery));